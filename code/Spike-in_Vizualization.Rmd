---
title: "SpikeIn MSstatsPTM Analysis"
author: "Devon Kohler"
date: "3/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages}
library(MSstatsPTMold)
library(MSstatsPTM)
library(data.table)
library(tidyverse)
library(limma)
```

## Spike-in Dataset Method Comparison


```{r include=FALSE}
## Some general function definitions -------------------------------------------

## Define metrics
calculate_summary_stats <- function(df, pval_col_name, comparison_col_name){
  
  ## FP/N (FPR)
  fpr <- df %>% filter((get(pval_col_name) < .05 & labeling == "light") | 
                (get(comparison_col_name) == "mix4 vs mix1" & get(pval_col_name) < .05)) %>% 
    nrow() / nrow(df %>% filter(labeling == "light" | get(comparison_col_name) == "mix4 vs mix1"))
  
  ## TP/P (TPR)
  recall <- df %>% filter(get(pval_col_name) < .05 & labeling == "heavy" & 
                                 get(comparison_col_name) != "mix4 vs mix1") %>% 
    nrow() / (50*5)
  
  ## TN/N (TNR)
  specificity <- df %>% filter(get(pval_col_name) >= .05 & (labeling == "light" |
                                 get(comparison_col_name) == "mix4 vs mix1")) %>% 
    nrow() / nrow(df %>% filter(labeling == "light" | get(comparison_col_name) == "mix4 vs mix1"))
  
  ## TP/TP+FP (PPV)
  precision <- df %>% filter(get(pval_col_name) < .05 & labeling == "heavy" & 
                               get(comparison_col_name) != "mix4 vs mix1") %>% 
    nrow() / nrow(df %>% filter(get(pval_col_name) < .05))
  
  ## TP + TN / N + P
  accuracy <- df %>% filter((get(pval_col_name) < .05 & labeling == "heavy" & 
                               get(comparison_col_name) != "mix4 vs mix1") | 
                              (get(pval_col_name) >= .05 & (labeling == "light" | 
                               get(comparison_col_name) == "mix4 vs mix1"))) %>% 
    nrow() / nrow(df)

  results_temp <- data.table(metric = c("FPR", "Recall", "Specificity", "Precision", "Accuracy"),
                             result = c(fpr, recall, specificity, precision, accuracy))
  return(results_temp)
}

```

### Data Stats

##### Missing Values

PTM: 20%
Protein: 30%

##### Average Features

PTM: 1.4
Protein: 10.2

### MSstatsPTM

#### Volcano Plot

```{r pressure, echo=FALSE, fig.width = 10, fig.height = 7}
load(file = "../data/MSstatsPTM_Summarized.rda")

load(file = "../data/Spike_in_MSstatsPTM_Model.rda")#model_df

model_df$ADJUSTED.Model <- model_df$ADJUSTED.Model %>% filter(is.finite(pvalue))
model_df$PTM.Model <- model_df$PTM.Model %>% filter(is.finite(pvalue))

model_df$ADJUSTED.Model$protadj = "MSstatsPTM"
model_df$PTM.Model$protadj = "MSstats"

plot_df <- rbind(model_df$ADJUSTED.Model %>% select(-GlobalProtein), 
              model_df$PTM.Model %>% select(-c(MissingPercentage,ImputationPercentage, issue)))
plot_df$protadj <- factor(plot_df$protadj, levels = c('MSstats','MSstatsPTM'))

## Update some naming conventions
plot_df[plot_df$Label == 'mix2 vs mix1'][['contrast_truth']] <- "LogFC: -1 (mix2-mix1)"
plot_df[plot_df$Label == 'mix3 vs mix1'][['contrast_truth']] <- "LogFC: 1 (mix3-mix1)"
plot_df[plot_df$Label == 'mix4 vs mix1'][['contrast_truth']] <- "LogFC: 0 (mix4-mix1)"
plot_df[plot_df$Label == 'mix3 vs mix2'][['contrast_truth']] <- "LogFC: 2 (mix3-mix2)"
plot_df[plot_df$Label == 'mix4 vs mix2'][['contrast_truth']] <- "LogFC: 1 (mix4-mix2)"
plot_df[plot_df$Label == 'mix4 vs mix3'][['contrast_truth']] <- "LogFC: -1 (mix4-mix3)"
plot_df$contrast_truth = factor(plot_df$contrast_truth, levels = 
                                  c("LogFC: -1 (mix2-mix1)",
                                    "LogFC: 1 (mix3-mix1)",
                                    "LogFC: 0 (mix4-mix1)",
                                    "LogFC: 2 (mix3-mix2)",
                                    "LogFC: 1 (mix4-mix2)",
                                    "LogFC: -1 (mix4-mix3)"))


plot_df[plot_df$labeling == 'light'][['labeling']] <- "Background Peptides"
plot_df[plot_df$labeling == 'heavy'][['labeling']] <- "Spike-in Peptides"

proposed_plot_df <- plot_df

# Volcano plot
png("../supplementary/sim_new/spike_in_msstatsptm_volcano.png", width = 1000, height = 500)
plot_df %>% arrange(labeling) %>% 
  filter(abs(log2FC) < Inf) %>% 
  ggplot(aes(log2FC, -log10(adj.pvalue))) + 
  geom_point(aes(color = labeling, alpha = labeling), size = 2.2) + 
  scale_color_manual(values = c("#999999", "#D55E00")) + 
  scale_alpha_manual(values = c(0.2, 1)) + 
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0) + 
  geom_vline(aes(xintercept = trueLog2FC),color = "darkred", linetype= "dashed") +
  geom_hline(yintercept = -log10(0.05), color = "darkred") + 
  facet_grid(protadj ~ contrast_truth) + 
  theme_bw() + 
  theme(axis.text.x = element_text(size = 16), 
       axis.text.y = element_text(size = 16), 
       legend.text=element_text(size=16),
       axis.title.y = element_text(size = 18, vjust=2),
       axis.title.x = element_text(size = 18),
       title = element_text(size = 20),
       strip.text = element_text(size = 15),
       legend.title =  element_blank(),
       legend.position = "bottom",
       legend.box.margin=margin(-10,-10,-10,-10)) + 
  scale_y_continuous(limits = c(0,5)) + 
  guides(colour = guide_legend(override.aes = list(size=5))) +
  labs(title = "MSstatsPTM VolcanoPlot")
dev.off()
```

#### Summary Statistics

Summary statistics for the models are given below.

```{r, echo = FALSE, fig.width = 8}

unadj_stats <- calculate_summary_stats(model_df$PTM.Model, 'adj.pvalue', "Label")
unadj_stats$Adjustment <- "no adjustment"
adj_stats <- calculate_summary_stats(model_df$ADJUSTED.Model, 'adj.pvalue', "Label")
adj_stats$Adjustment <- "protein adjustment"
msstatsptm_stats <- rbindlist(list(unadj_stats, adj_stats))

msstatsptm_stats %>% ggplot() + geom_col(aes(x = metric, y = result, fill = Adjustment), position = "dodge") + 
  scale_fill_manual(values = c("salmon1", "steelblue1")) + 
  labs(title = "MSstatsPTM - Summary Statistics", x = "Metric", y = "Value")

```


#### Log Fold Change - Spike-in Peptides


```{r, echo = FALSE, fig.width = 10, fig.height = 5}
unadj_spike <- model_df$PTM.Model %>% filter(labeling == "heavy")
unadj_spike$Adjustment <- "MSstats"
adj_spike <- model_df$ADJUSTED.Model %>% filter(labeling == "heavy")
adj_spike$Adjustment <- "MSstatsPTM"
spike <- rbindlist(list(unadj_spike, adj_spike), fill = TRUE)

spike %>% ggplot() + geom_boxplot(aes(x = contrast_truth, y = log2FC), fill = "lightsteelblue4") + 
  geom_point(aes(y = trueLog2FC, x = contrast_truth), color = "red", shape = 4, size = 3) + facet_wrap(.~Adjustment) + 
  labs(title = "MSstatsPTM Fold Change of Spike-in Peptides", x = "Comparison with Expected FC") + theme(axis.text.x = element_text(angle = 30, vjust = .5))
 
```


#### Calculating background peptide percentages

```{r, echo=FALSE}

light_pep <- model_df$PTM.Model %>% filter(labeling == "light")

unadj_sig_light <- model_df$PTM.Model %>% filter(labeling == "light" & adj.pvalue < .05)
adj_sig_light <- model_df$ADJUSTED.Model %>% filter(labeling == "light" & adj.pvalue < .05)

nrow(unadj_sig_light) / nrow(light_pep)
nrow(adj_sig_light) / nrow(light_pep)

```


### Limma

We will repeat the above analysis for Limma.

#### Volcano Plot


```{r, echo=FALSE, fig.width = 10, fig.height = 7}
load(file = "../data/Spike_in_Limma_Model.rda")#limma_model

limma_model <- list(PTM.Model = limma_model %>% filter(protadj == "no adjustment"),
                    ADJUSTED.Model = limma_model %>% filter(protadj == "protein adjustment"))

limma_model$PTM.Model %>% filter(labeling == "light" & adj.pvalue < .05) %>% nrow() / limma_model$PTM.Model %>% nrow()
limma_model$ADJUSTED.Model %>% filter(labeling == "light" & adj.pvalue < .05) %>% nrow() / limma_model$ADJUSTED.Model %>% nrow()

limma_model$ADJUSTED.Model <- limma_model$ADJUSTED.Model %>% filter(is.finite(pvalue))
limma_model$PTM.Model <- limma_model$PTM.Model %>% filter(is.finite(pvalue))

limma_model$ADJUSTED.Model$protadj = "Limma"
limma_model$PTM.Model$protadj = "basic Limma"

plot_df <- rbind(limma_model$ADJUSTED.Model, limma_model$PTM.Model, fill = TRUE)
plot_df$protadj <- factor(plot_df$protadj, levels = c('basic Limma','Limma'))

## Update some naming conventions
plot_df[plot_df$Label == 'mix2 vs mix1'][['contrast_truth']] <- "LogFC: -1 (mix2-mix1)"
plot_df[plot_df$Label == 'mix3 vs mix1'][['contrast_truth']] <- "LogFC: 1 (mix3-mix1)"
plot_df[plot_df$Label == 'mix4 vs mix1'][['contrast_truth']] <- "LogFC: 0 (mix4-mix1)"
plot_df[plot_df$Label == 'mix3 vs mix2'][['contrast_truth']] <- "LogFC: 2 (mix3-mix2)"
plot_df[plot_df$Label == 'mix4 vs mix2'][['contrast_truth']] <- "LogFC: 1 (mix4-mix2)"
plot_df[plot_df$Label == 'mix4 vs mix3'][['contrast_truth']] <- "LogFC: -1 (mix4-mix3)"
plot_df$contrast_truth = factor(plot_df$contrast_truth, levels = 
                                  c("LogFC: -1 (mix2-mix1)",
                                    "LogFC: 1 (mix3-mix1)",
                                    "LogFC: 0 (mix4-mix1)",
                                    "LogFC: 2 (mix3-mix2)",
                                    "LogFC: 1 (mix4-mix2)",
                                    "LogFC: -1 (mix4-mix3)"))


plot_df[plot_df$labeling == 'light'][['labeling']] <- "Background Peptides"
plot_df[plot_df$labeling == 'heavy'][['labeling']] <- "Spike-in Peptides"

limma_plot_df <- plot_df

# Volcano plot
png("../supplementary/sim_new/spike_in_limma_volcano.png", width = 1000, height = 500)
plot_df %>% arrange(labeling) %>% 
  filter(is.finite(Log2FC)) %>%
  ggplot(aes(Log2FC, -log10(adj.pvalue))) + 
  geom_point(aes(color = labeling, alpha = labeling), size = 2.2) + 
  scale_color_manual(values = c("#999999", "#D55E00")) + 
  scale_alpha_manual(values = c(0.2, 1)) + 
  #scale_size_manual(values = c(2, 1)) + 
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0) + 
  geom_vline(aes(xintercept = trueLog2FC),color = "darkred", linetype= "dashed") +
  geom_hline(yintercept = -log10(0.05), color = "darkred") + 
  facet_grid(protadj ~ contrast_truth) + 
  theme_bw() + 
  theme(axis.text.x = element_text(size = 16), 
       axis.text.y = element_text(size = 16), 
       legend.text=element_text(size=16),
       axis.title.y = element_text(size = 18, vjust=2),
       axis.title.x = element_text(size = 18),
       title = element_text(size = 20),
       strip.text = element_text(size = 15),
       legend.title =  element_blank(),
       legend.position = "bottom",
       legend.box.margin=margin(-10,-10,-10,-10)) + 
  # scale_y_continuous(limits = c(0,3)) + 
  guides(colour = guide_legend(override.aes = list(size=5))) +
  labs(title = "Limma VolcanoPlot")
dev.off()
```

#### Create combo plot of proposed and limma

``` {r, echo = FALSE}

proposed_plot_df$Model <- "MSstatsPTM"
proposed_plot_df[proposed_plot_df$protadj == "MSstats"]$protadj = "no adjustment"
proposed_plot_df[proposed_plot_df$protadj == "MSstatsPTM"]$protadj = "protein adjustment"
limma_plot_df$Model <- "Limma"
limma_plot_df$Protein <- limma_plot_df$PTM
limma_plot_df$log2FC <- limma_plot_df$Log2FC
limma_plot_df[limma_plot_df$protadj == "basic Limma"]$protadj = "no adjustment"
limma_plot_df[limma_plot_df$protadj == "Limma"]$protadj = "protein adjustment"

combo_plot_df <- rbind(proposed_plot_df[, c("Protein", "Label", "log2FC", 
                                            "adj.pvalue", "labeling", 
                                            "trueLog2FC", "contrast_truth", 
                                            "protadj", "Model")], 
                       limma_plot_df[, c("Protein", "Label", "log2FC", 
                                            "adj.pvalue", "labeling", 
                                            "trueLog2FC", "contrast_truth", 
                                            "protadj", "Model")])
combo_plot_df$Model <- factor(combo_plot_df$Model, levels=c('MSstatsPTM','Limma'))

png("../main/images/spike_in_volcano.png", width = 750, height = 500)
combo_plot_df %>% arrange(Model, labeling) %>% 
  filter(abs(log2FC) < Inf & Label %in% c("mix3 vs mix2",
                                          "mix4 vs mix2")) %>%
  ggplot(aes(log2FC, -log10(adj.pvalue))) + 
  geom_point(aes(color = labeling, alpha = labeling), size = 2.2) + 
  scale_color_manual(values = c("#999999", "#D55E00")) + 
  scale_alpha_manual(values = c(0.2, 1)) + 
  #scale_size_manual(values = c(2, 1)) + 
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0) + 
  geom_vline(aes(xintercept = trueLog2FC),color = "darkred", linetype= "dashed") +
  geom_hline(yintercept = -log10(0.05), color = "darkred") + 
  facet_grid(protadj ~ Model + contrast_truth) + 
  theme_bw() + 
  theme(axis.text.x = element_text(size = 16), 
       axis.text.y = element_text(size = 16), 
       legend.text=element_text(size=16),
       axis.title.y = element_text(size = 18, vjust=2),
       axis.title.x = element_text(size = 18),
       title = element_text(size = 20),
       strip.text = element_text(size = 15),
       legend.title =  element_blank(),
       legend.position = "bottom",
       legend.box.margin=margin(-10,-10,-10,-10)) + 
  scale_y_continuous(limits = c(0,3)) + 
  guides(colour = guide_legend(override.aes = list(size=5))) +
  labs(title = "SpikeIn VolcanoPlot", x= "Log2FC")
dev.off()

```

#### Summary Statistics

Summary statistics for the models are given below.

```{r, echo = FALSE, fig.width = 8}

unadj_stats <- calculate_summary_stats(limma_model$PTM.Model, 'adj.pvalue', "Label")
unadj_stats$Adjustment <- "no adjustment"
adj_stats <- calculate_summary_stats(limma_model$ADJUSTED.Model, 'adj.pvalue', "Label")
adj_stats$Adjustment <- "protein adjustment"
limma_stats <- rbindlist(list(unadj_stats, adj_stats))

limma_stats %>% ggplot() + geom_col(aes(x = metric, y = result, fill = Adjustment), position = "dodge") + 
  scale_fill_manual(values = c("salmon1", "steelblue1")) + 
  labs(title = "Limma - Summary Statistics", x = "Metric", y = "Value")

```

#### Log Fold Change - Spike-in Peptides


```{r, echo = FALSE, fig.width = 10, fig.height = 5}
unadj_spike <- limma_model$PTM.Model %>% filter(labeling == "heavy")
unadj_spike$Adjustment <- "no adjustment"
adj_spike <- limma_model$ADJUSTED.Model %>% filter(labeling == "heavy")
adj_spike$Adjustment <- "protein adjustment"
spike <- rbindlist(list(unadj_spike, adj_spike), fill = TRUE)

spike %>% ggplot() + geom_boxplot(aes(x = contrast_truth, y = Log2FC), fill = "lightsteelblue4") + 
  geom_point(aes(y = trueLog2FC, x = contrast_truth), color = "red", shape = 4, size = 3) + facet_wrap(.~Adjustment) + 
  labs(title = "Fold Change of Spike-in Peptides", x = "Comparison with Expected FC") + theme(axis.text.x = element_text(angle = 30, vjust = .5))
 
```

### Anova

#### Volcano Plot

```{r, echo=FALSE, fig.width = 10, fig.height = 7}
load(file = "../data/anova_results.rda")#anova_results

anova_results$contrast_truth = ""
anova_results$trueLog2FC=0

anova_results[anova_results$protadj == "no adjustment"]$protadj = "basic ANOVA"
anova_results[anova_results$protadj == "protein adjustment"]$protadj = "ANOVA"

## Update some naming conventions
anova_results[anova_results$label == 'mix2 vs mix1'][['contrast_truth']] <- "LogFC: -1 (mix2-mix1)"
anova_results[anova_results$label == 'mix3 vs mix1'][['contrast_truth']] <- "LogFC: 1 (mix3-mix1)"
anova_results[anova_results$label == 'mix4 vs mix1'][['contrast_truth']] <- "LogFC: 0 (mix4-mix1)"
anova_results[anova_results$label == 'mix3 vs mix2'][['contrast_truth']] <- "LogFC: 2 (mix3-mix2)"
anova_results[anova_results$label == 'mix4 vs mix2'][['contrast_truth']] <- "LogFC: 1 (mix4-mix2)"
anova_results[anova_results$label == 'mix4 vs mix3'][['contrast_truth']] <- "LogFC: -1 (mix4-mix3)"

anova_results[anova_results$label == 'mix2 vs mix1'][['trueLog2FC']] <- -1
anova_results[anova_results$label == 'mix3 vs mix1'][['trueLog2FC']] <- 1
anova_results[anova_results$label == 'mix4 vs mix1'][['trueLog2FC']] <- 0
anova_results[anova_results$label == 'mix3 vs mix2'][['trueLog2FC']] <- 2
anova_results[anova_results$label == 'mix4 vs mix2'][['trueLog2FC']] <- 1
anova_results[anova_results$label == 'mix4 vs mix3'][['trueLog2FC']] <- -1

anova_results[anova_results$labeling == 'light'][['labeling']] <- "Background Peptides"
anova_results[anova_results$labeling == 'heavy'][['labeling']] <- "SpikeIn Peptides"

anova_results$contrast_truth = factor(anova_results$contrast_truth, 
                                          levels = 
                                  c("LogFC: -1 (mix2-mix1)",
                                    "LogFC: 1 (mix3-mix1)",
                                    "LogFC: 0 (mix4-mix1)",
                                    "LogFC: 2 (mix3-mix2)",
                                    "LogFC: 1 (mix4-mix2)",
                                    "LogFC: -1 (mix4-mix3)"))

# Volcano plot
png("../supplementary/sim_new/spike_in_anova_volcano.png", width = 1000, height = 500)
anova_results %>% arrange(protadj, labeling) %>% 
  filter(is.finite(log2FC)) %>%
  ggplot(aes(log2FC, -log10(adj.pvalue))) + 
  geom_point(aes(color = labeling, alpha = labeling), size = 2.2) + 
  scale_color_manual(values = c("#999999", "#D55E00")) + 
  scale_alpha_manual(values = c(0.1, 1)) + 
  #scale_size_manual(values = c(2, 1)) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0) + 
  geom_vline(aes(xintercept = trueLog2FC),color = "darkred", linetype= "dashed") +
  geom_hline(yintercept = -log10(0.05), color = "darkred") + 
  facet_grid(protadj ~ contrast_truth) + 
  theme_bw() + 
  theme(axis.text.x = element_text(size = 14), 
       axis.text.y = element_text(size = 14), 
       legend.text=element_text(size=16),
       axis.title.y = element_text(size = 18, vjust=2),
       axis.title.x = element_text(size = 18),
       title = element_text(size = 20),
       strip.text = element_text(size = 15),
       legend.title =  element_blank(),
       legend.position = "bottom",
       legend.box.margin=margin(-10,-10,-10,-10)) + 
  # scale_y_continuous(limits = c(0,1.5)) + 
  guides(colour = guide_legend(override.aes = list(size=5))) + 
  labs(title = "ANOVA VolcanoPlot")
dev.off()

```

#### Log Fold Change - Spike-in Peptides


```{r, echo = FALSE, fig.width = 10, fig.height = 5}
unadj_spike <- ttest_final_model %>% filter(protadj == "no adjustment" & labeling == "heavy")
unadj_spike$Adjustment <- "no adjustment"
adj_spike <- ttest_final_model %>% filter(protadj == "protein adjustment" & labeling == "heavy")
adj_spike$Adjustment <- "protein adjustment"
spike <- rbindlist(list(unadj_spike, adj_spike), fill = TRUE)

spike %>% ggplot() + geom_boxplot(aes(x = contrast_truth, y = estimate), fill = "lightsteelblue4") + 
  geom_point(aes(y = trueLog2FC, x = contrast_truth), color = "red", shape = 4, size = 3) + facet_wrap(.~Adjustment) + 
  labs(title = "T-test Fold Change of Spike-in Peptides", x = "Comparison with Expected FC", y = "log2FC") + theme(axis.text.x = element_text(angle = 30, vjust = .5))

```


### Summary

```{r, echo = FALSE, fig.width = 8}
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")

limma_sum <- limma_stats %>% filter(Adjustment == "protein adjustment") 
limma_sum$Model <- "Limma"
msstatsptm_sum <- msstatsptm_stats  %>% filter(Adjustment == "protein adjustment") 
msstatsptm_sum$Model <- "MSstatsPTM"

anova_results[anova_results$labeling == 'Background Peptides'][['labeling']] <- "light"
anova_results[anova_results$labeling == 'SpikeIn Peptides'][['labeling']] <- "heavy"
anova_summary <- calculate_summary_stats(anova_results %>% filter(protadj == "protein adjustment"), 'adj.pvalue', "label")
anova_summary$Adjustment <- "protein adjustment"
anova_summary$Model <- "ANOVA"        

summary <- rbindlist(list(msstatsptm_sum, limma_sum, anova_summary))
summary[Model == "MSstatsPTM"]$Model <- "Proposed"

summary %>% mutate(Model = factor(Model, levels=c("Proposed", "Limma", "Anova"))) %>% 
  ggplot() + geom_col(aes(x = metric, y = result, fill = Model), position = "dodge") + 
    scale_fill_manual(values=cbPalette) +
  #scale_fill_manual(values = c("salmon1", "steelblue1", "green")) + 
  labs(title = "Summary Statistic Comparison", x = "Metric", y = "Result") + 
  theme_bw() + 
    theme(axis.text.x = element_text(size = 18), 
       axis.text.y = element_text(size = 18), 
       legend.text=element_text(size=18),
       axis.title.y = element_text(size = 20, vjust=2),
       axis.title.x = element_text(size = 20),
       title = element_text(size = 20),
       #strip.text = element_text(size = 15),
       legend.position = "right")
```


```{r, echo = FALSE, fig.width = 8}

unadj_spike_msstats <- model_df$PTM.Model %>% filter(labeling == "heavy")
unadj_spike_msstats$Adjustment <- "no adjustment"
unadj_spike_msstats$Model <- "MSstatsPTM"
adj_spike_msstats <- model_df$ADJUSTED.Model %>% filter(labeling == "heavy")
adj_spike_msstats$Adjustment <- "protein adjustment"
adj_spike_msstats$Model <- "MSstatsPTM"

unadj_spike_ttest <- anova_results %>% filter(labeling == "SpikeIn Peptides" & protadj == "no adjustment")
unadj_spike_ttest <- setNames(unadj_spike_ttest, c("Protein", "Label", "log2FC", "SE", "Tvalue", 
                                                   "pvalue", "protadj", "adj.pvalue", "labeling", 
                                                   "contrast_truth", "trueLog2FC"))

unadj_spike_ttest$Adjustment <- "no adjustment"
unadj_spike_ttest$Model <- "ANOVA"

adj_spike_ttest <- anova_results %>% filter(labeling == "SpikeIn Peptides" & protadj != "no adjustment")
adj_spike_ttest <- setNames(adj_spike_ttest, c("Protein", "Label", "log2FC", "SE", "Tvalue", 
                                                   "pvalue", "protadj", "adj.pvalue", "labeling", 
                                                   "contrast_truth", "trueLog2FC"))
adj_spike_ttest$Adjustment <- "protein adjustment"
adj_spike_ttest$Model <- "ANOVA"

unadj_spike_limma <- limma_model$PTM.Model %>% filter(labeling == "heavy")
unadj_spike_limma <- setNames(unadj_spike_limma, c("Protein", "Label", "log2FC", "pvalue", "DF", 
                                                   "SE", "labeling", "adj.pvalue", 
                                                   "trueLog2FC", "contrast_truth", "protadj"))
unadj_spike_limma$Adjustment <- "no adjustment"
unadj_spike_limma$Model <- "Limma"
adj_spike_limma <- limma_model$ADJUSTED.Model %>% filter(labeling == "heavy")
adj_spike_limma <- setNames(adj_spike_limma, c("Protein", "Label", "log2FC", "pvalue", "df", 
                                                   "SE", "labeling", "adj.pvalue", 
                                                   "trueLog2FC", "contrast_truth", "protadj"))
adj_spike_limma$Adjustment <- "protein adjustment"
adj_spike_limma$Model <- "Limma"

spike <- rbindlist(list(unadj_spike_msstats, adj_spike_msstats, unadj_spike_ttest,
                        adj_spike_ttest, unadj_spike_limma, adj_spike_limma), fill = TRUE)
spike <- as.data.table(spike)
# spike[spike$Model == "MSstatsPTM", Model := "Proposed"]
#plot_df[plot_df$Label == 'mix1-mix3'][['contrast_truth']]
spike$`color_label` <- "True LogFC"

png("../main/images/spike_in_fc.png", width = 750, height = 500)
spike %>% mutate(Comparison = str_split(contrast_truth, " ", simplify = TRUE)[,1],
      Model = factor(Model, levels=c("MSstatsPTM", "Limma", "ANOVA"))) %>%
  filter(!Label %in% c("mix1-mix2", "mix3-mix4")) %>% 
  ggplot() + 
  geom_boxplot(aes(x = Label, y = log2FC, fill = Model)) + 
  geom_point(aes(y = trueLog2FC, x = Label, color = color_label), 
             shape = 4, size = 4, stroke = 2) + 
  scale_fill_manual(values=cbPalette) +
  scale_color_manual(name = "", values="red", label="True LogFC") + 
 facet_wrap(.~Adjustment) + 
    theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust = 1, size = 16), 
       axis.text.y = element_text(size = 16), 
       legend.text=element_text(size=18),
       axis.title.y = element_text(size = 18),
       axis.title.x = element_text(size = 18),
       title = element_text(size = 20),
       strip.text = element_text(size = 18),
       legend.position = "bottom") + 
  labs(title = "Fold Change of Spike-in Peptides", x = "Comparison with Expected FC")
dev.off()

```
